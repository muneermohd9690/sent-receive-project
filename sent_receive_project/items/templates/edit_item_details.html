{% extends 'mainpage.html' %}
{% load static %}
{% block content %}

    <div class="container">
      <h2>Item Details</h2>
       <input type="hidden" name="itemdetails_id" value="{{itemdetails.id}}">
       <input class="form-control" id="search" type="text" placeholder="Search..">
              <div class="table-responsive">

                  <table class="table table-bordered" id="myTable">
                      <thead>
                          <tr>
                              <th>Model Number</th>
                              <th>Serial Number</th>
                              <th>Tag Number</th>
                              <th>Room Tag</th>
                              <th>Issued to</th>
                              <th>Employee Name</th>
                              <th>Employee Designation</th>
                              <th>Action</th>

                          </tr>
                      </thead>
                      <tbody >
                          {% for detail in itemdetails %}
                          <tr id="{{detail.pk}}" data-id="{{ detail.pk }}">
                              <td>{{detail.model_no.model_no}}</td>
                              <td>{{detail.serial_no}}</td>
                              <td>{{detail.tag_no}}</td>
                              <td>{{detail.room_tag}}</td>
                              <td>{{detail.issued_to.name}}</td>
                              <td>{{detail.employee_name}}</td>
                              <td>{{detail.employee_designation}}</td>
                              <td><!--<a href="{% url 'edit_item_details_form' detail.id %}" class="btn btn-warning"
                                         data-bs-toggle="tooltip" data-bs-placement="bottom" title="Edit"><i
                                              class="fas fa-edit"></i>
                                  </a>-->


                                  <button type="button" class="btn btn-warning" onclick="openModal('{{ detail.pk }}')">
                                      <i class="fas fa-edit"></i>
                                  </button>

                              </td>
                          </tr>
                          <!-- Edit Modal -->


                          <!-- Edit Modal -->
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
               <!-- The Modal -->
                <div class="modal" id="{{ detail.pk }}editItemDetailsModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="{{ detail.pk }}editItemDetailsModalLabel">Edit Item Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="editItemDetailsForm" role="form" action="{% url 'edit_item_details_save' %}" method="post">
                                    {% csrf_token %}

                                    <div class="modal-body" id="{{ detail.pk }}modalBody">
                                        <!-- Modal content will be loaded here dynamically -->
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit"  class="btn btn-success">Save Changes</button>
                                    </div>
                            </form>
                        </div>
                    </div>
                </div>
               <script>
                    function handleFormSubmission(event) {
                        event.preventDefault();
                         var currentRowId = $("#item_id").data("value");
                        // Use SweetAlert to confirm before submitting the form
                        Swal.fire({
                            title: 'Confirm Changes',
                            text: 'Are you sure you want to save changes?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, save it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // User confirmed, proceed with the form submission
                                submitForm();
                                $('#{{ detail.pk }}editItemDetailsModal').modal('hide');
                                console.log('Applying visual effect to row:', currentRowId);



                            }
                            else
                            {
                                    swal("Cancelled"," No changes were made", "error");
                                    $('#{{ detail.pk }}editItemDetailsModal').modal('hide');
                            }
                        });
                    }

                    function submitForm() {
                        // Get the form data
                        var formData = $('#editItemDetailsForm').serialize();

                        // Save the current row ID for later use
                       var currentRowId = $("#item_id").data("value");


                        $.ajax({
                            type: 'POST',
                            url: '{% url "edit_item_details_save" %}',
                            data: formData,

                            success: function (data) {
<!--                                $('#{{ detail.pk }}editItemDetailsModal').modal('hide');-->
                                applyVisualEffect(currentRowId);
                                Swal.fire({
                                    title: 'Changes Saved',
                                    text: 'Your changes have been successfully saved.',
                                    icon: 'success'
                                });

                            },
                            error: function (error) {
                                console.error('Error saving data:', error);
                                // Handle errors if needed
                            }
                        });
                    }
                    function applyVisualEffect(currentRowId) {
                        var $row = $('#' + currentRowId);
                        console.log('Applying visual effect to row:', currentRowId);
                        // Add a class to the row
                        $row.addClass('edited-row');
                        $row.css('background-color', 'yellow');

                        setTimeout(function () {
                            // Remove the class after a delay
                            $row.removeClass('edited-row');
                        }, 9000); // 2000 milliseconds (2 seconds) delay
                    }
                    $('body').on('submit', '#editItemDetailsForm', handleFormSubmission);
                    function openModal(detailId) {

                                    $.ajax({
                                        url: '{% url "edit_item_details_modal" %}',
                                        type: 'GET',
                                        data: { detail_id: detailId },
                                        success: function (response) {

                                            $('#{{ detail.pk }}editItemDetailsModalLabel').text('Edit Item Details - ' + detailId);
                                            $('#{{ detail.pk }}modalBody').html(response);


                                            $('#{{ detail.pk }}editItemDetailsModal').modal('show');
                                        },
                                        error: function (error) {
                                            console.error('Error fetching data:', error);
                                        }
                                    });
                    }
               </script>

                <script>
                    window.onload = function() {
                        // Find all elements with the class 'bs-searchbox' containing an input element of type 'search'
                        var searchboxes = document.querySelectorAll('.bs-searchbox input[type="search"]');

                        // Iterate through the NodeList and set unique IDs
                        searchboxes.forEach(function(searchInput, index) {
                            var uniqueId = 'search_input_' + index;  // You can modify this based on your requirements
                            searchInput.id = uniqueId;
                            <!---->console.log('Set ID for element:', uniqueId);
                        });

                        // Your code here
                    };
                </script>
    </div>

{% endblock %}